services:
  # ElectOMate Backend Application - Production Configuration
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: electomate-backend-prod
    restart: always
    environment:
      # Production Database URL - uses external database host
      POSTGRES_URL: postgresql+psycopg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-em_prod}
      
      # Weaviate Configuration (from .env)
      WV_URL: ${WV_URL}
      WV_API_KEY: ${WV_API_KEY}
      
      # OpenAI Configuration (from .env)
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      
      # Application Environment
      ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8000:8000"
    networks:
      - electomate-prod-network
    # No postgres dependency - using external database
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Resource limits for production
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    # Security options
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m

# Networks
networks:
  electomate-prod-network:
    driver: bridge
    name: electomate-prod-network